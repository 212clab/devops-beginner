# grafana-complete-setup.yaml

# 1. Grafanaì—ê²Œ ëŒ€ì‹œë³´ë“œë¥¼ ì–´ë””ì„œ ì°¾ì„ì§€ ì•Œë ¤ì£¼ëŠ” ì„¤ì • (Provider)
apiVersion: v1
kind: ConfigMap
metadata:
  name: grafana-dashboard-provider
  namespace: monitoring
  labels:
    app: grafana
data:
  # ì´ íŒŒì¼ì´ /etc/grafana/provisioning/dashboards/ ì— ìƒì„±ë©ë‹ˆë‹¤.
  default-provider.yaml: |-
    apiVersion: 1
    providers:
    # 'default' ë¼ëŠ” ì´ë¦„ì˜ í”„ë¡œë°”ì´ë”ë¥¼ ì •ì˜í•©ë‹ˆë‹¤.
    - name: 'default'
      orgId: 1
      folder: ''
      type: file
      disableDeletion: false
      editable: true
      options:
        # ì´ ê²½ë¡œì— ìˆëŠ” .json íŒŒì¼ì„ ëª¨ë‘ ëŒ€ì‹œë³´ë“œë¡œ ë¶ˆëŸ¬ì˜µë‹ˆë‹¤.
        path: /var/lib/grafana/dashboards/default

---
# 2. ì‹¤ì œ FinOps ëŒ€ì‹œë³´ë“œ ë‚´ìš©ì„ ë‹´ê³  ìˆëŠ” ConfigMap
apiVersion: v1
kind: ConfigMap
metadata:
  name: finops-cost-analysis-dashboard
  namespace: monitoring
  labels:
    app: grafana
data:
  # ì´ íŒŒì¼(finops-cost-analysis.json)ì´ ìœ„ì—ì„œ ì§€ì •í•œ pathì— ìƒì„±ë©ë‹ˆë‹¤.
  finops-cost-analysis.json: |-
    {
      "__inputs": [],
      "__requires": [],
      "annotations": {
        "list": []
      },
      "editable": true,
      "gnetId": null,
      "graphTooltip": 0,
      "id": null,
      "panels": [
        {
          "title": "FinOps Dashboard Placeholder",
          "type": "text",
          "description": "Please paste your full dashboard JSON here."
        }
      ],
      "refresh": "1m",
      "schemaVersion": 36,
      "title": "FinOps Cost Analysis",
      "uid": "finops-cost-analysis"
    }

---
# 3. Grafana Service (NodePortë¡œ ì™¸ë¶€ ë…¸ì¶œ)
apiVersion: v1
kind: Service
metadata:
  name: grafana
  namespace: monitoring
spec:
  selector:
    app: grafana
  type: NodePort # ğŸ’¡ ì™¸ë¶€ ì ‘ì†ì„ ìœ„í•´ NodePort ì‚¬ìš©
  ports:
    - protocol: TCP
      port: 3000
      targetPort: 3000
      nodePort: 30091 # ğŸ’¡ ê³ ì •ëœ í¬íŠ¸ë¡œ ì ‘ì†

---
# 4. Grafana Deployment (ConfigMapì„ Volumeìœ¼ë¡œ ë§ˆìš´íŠ¸í•˜ëŠ” ë¶€ë¶„ ì¶”ê°€)
apiVersion: apps/v1
kind: Deployment
metadata:
  name: grafana
  namespace: monitoring
spec:
  replicas: 1
  selector:
    matchLabels:
      app: grafana
  template:
    metadata:
      labels:
        app: grafana
    spec:
      containers:
        - name: grafana
          image: grafana/grafana:latest
          ports:
            - containerPort: 3000
          # ğŸ’¡ [í•µì‹¬] ìœ„ì—ì„œ ë§Œë“  ConfigMapë“¤ì„ Volumeìœ¼ë¡œ ì»¨í…Œì´ë„ˆì— ì—°ê²°í•©ë‹ˆë‹¤.
          volumeMounts:
            # 1ë²ˆ ConfigMapì„ ë§ˆìš´íŠ¸ -> Grafanaê°€ í”„ë¡œë¹„ì €ë‹ ì„¤ì •ì„ ì½ìŒ
            - name: grafana-dashboard-provider-volume
              mountPath: /etc/grafana/provisioning/dashboards
            # 2ë²ˆ ConfigMapì„ ë§ˆìš´íŠ¸ -> Grafanaê°€ ì‹¤ì œ ëŒ€ì‹œë³´ë“œ íŒŒì¼ì„ ì½ìŒ
            - name: grafana-dashboards-volume
              mountPath: /var/lib/grafana/dashboards/default
      # ğŸ’¡ [í•µì‹¬] ì»¨í…Œì´ë„ˆì—ì„œ ì‚¬ìš©í•  Volumeë“¤ì„ ì •ì˜í•©ë‹ˆë‹¤.
      volumes:
        - name: grafana-dashboard-provider-volume
          configMap:
            name: grafana-dashboard-provider
        - name: grafana-dashboards-volume
          configMap:
            name: finops-cost-analysis-dashboard
